# HTML5视频播放器的自定制

### Intro

#### 案例目的：
在React项目中使用video.js，实现HTML5视频播放器的自定制。

#### 关于[video.js](http://videojs.com/)：
引用官方的自我介绍：

>Video.js is a free and open source HTML5 video player.

这是个免费且开源的HTML5视频播放器。


重点步骤之
### 空格键控制播放/暂停的实现

video.js的默认动作是，仅仅在control bar的播放键被鼠标选中时，才能用空格/回车键控制播放/暂停。不太方便。
我们的目标是：点开视频后，就可以通过空格键控制视频的播放/暂停。

#### 引入插件

我们可以通过写自己的[插件](http://docs.videojs.com/docs/guides/plugins.html)来实现额外的功能。参考这篇文档，尝试如下：

VideoPlayer.js中

```
··· ···
render () {
   // 写插件：当监听到播放器实例的播放（play）事件，就输出一条语句
   function examplePlugin(options) {
       this.on('play', function(e) {
         console.log('playback has started!');
       });
     };

   // 注册该插件
   videojs.registerPlugin('examplePlugin', examplePlugin)

   return (
     ··· ···
```

目前插件已经存在，可以根据需要打开或关闭它

下面尝试使用

CourseContainer.js中
```
··· ···
const CourseVideoJsOptions = {
  autoplay: false,
  controls: true,

  ... ...

  // 使用该插件
  plugins: {
    setStateandFocusPlugin: true
  }
}
... ...
```

完成以上步骤后，再次点开视频，发现控制台输出了 `playback has started!` ，说明插件应用成功。

关于代码中的事件监听，参考文档[Event Target](http://docs.videojs.com/tutorial-event-target.html)

#### 设置播放器实例的状态

在插件代码中加一条console语句如下。

如此，在控制台中，就可以在点开视频时看到，这句代码输出了该播放器的实例对象

VideoPlayer.js
```
··· ···
function examplePlugin(options) {
    this.on('play', function(e) {
      console.log(this)
      console.log('playback has started!')
    });
  };
  ... ...
```

仔细查看该对象的属性，发现有 `setState`和`state`两条。
据此，我们尝试根据播放器的播放状态来设置`state`值

注意，这和React组件的state是两回事。

VideoPlayer.js
```
··· ···
this.on('play', function (e) {
  console.log(this);
  console.log('playback has started!')
  this.setState({
    state: 'playing'
  })
  console.log(this.state.state)
})

this.on('pause', function (e) {
  console.log('playback has paused')
  this.setState({
    state: 'pause'
  })
  console.log(this.state.state)
})
... ...
```

此时，再让视频播放/暂停，都会看到控制台输出的状态，说明设置成功。

#### 初步改进空格键的功能

空格键的默认动作是:
* 当鼠标选中control bar的播放键时，空格键可以切换播放/暂停；
* 当鼠标选中全屏键时，空格键可以切换全屏；
* 当鼠标选中静音键时，空格键可以切换静音；
* 当鼠标什么也没选中时，空格键无法控制播放器的任何功能。

这样既麻烦又不实用，因为只有“播放/暂停”功能才是使用频率最高的功能。让空格键在任何情况下都能直接控制暂停功能，可以明显提升用户体验。

接下来，我们需要监听“按下空格键”这个事件。这个需求可以分为两步：
  * 监听键盘事件
  * 判断是否为空格键

对于前者，我们可以使用[onKeyDown事件](http://www.w3school.com.cn/jsref/event_onkeydown.asp)，它会在用户按下一个键盘按键时发生。

对于后者，涉及到[keyCode/键码-文档链接待补充]()的知识。具体到这个案例，空格键的键码是32。

推荐[这个网站](http://keycode.info)，它可以很方便地查询键盘各个按键的键码，十分好用。

通过onKeyDown事件的文档可以看到，<video>标签不支持它，所以我们把它写在包裹<video>标签的<div>标签中。代码如下

VideoPlayer.js
```
··· ···
videojs.registerPlugin('setStateandFocusPlugin', setStateandFocusPlugin)
// videojs.registerPlugin('handleKeyPress', handleKeyPress)

return (
  <div data-vjs-player
    onKeyDown={this.handleSpaceKeyDown}
    >
    <video
    ref={node => this.videoNode = node}
    className='video-js vjs-hqcat'
    />
    </div>
    )
  }
}
```

由于JS的[事件冒泡-文档链接待补充]()机制，onKeyDown事件是可以成功捕获的。

事实上，如果在目前这个div标签的外层再套一层div，外层的div也同样能够捕获onKeyDown事件，有兴趣的可以试一下。

接下来写监听到onKeyDown事件后调用的函数：

* 首先，我们需要判断是否为空格键。
* 如果是，我们需要禁止原来默认的动作。
* 然后，利用之前设置的视频播放状态，进行相应的操作：
  * 如果视频正在播放中，则暂停视频
  * 如果视频正在暂停中，则继续播放视频

VideoPlayer.js
```
··· ···
componentWillUnmount () {
  if (this.player) {
    this.player.dispose()
  }
}

handleSpaceKeyDown = (event) => {
  // 判断是否为空格键
  if (event.which === 32) {
    event.preventDefault()
    if (this.player) {
      // 根据播放状态的不同，进行相应的操作
      switch (this.player.state.state) {
        case 'playing':
        this.player.pause()
        break
        case 'pause':
        this.player.play()
        break
        default: return
      }
    } else {
      console.log('error')
    }
  }
}
... ...
```

至此，我们完成了初步的改进。但目前扔有一些问题：
* 点击视频播放后，必须再点一下视频，才能用空格键控制暂停/播放；
* 如果在播放时，鼠标点一下页面上的其他地方，空格键又失效了。

下一步来解决这些问题。

#### 改进焦点管理

元素获得焦点的方式有页面加载、用户输入（通常是通过Tab按键）和在代码中调用focus()方法。相应的文档获得了焦点，用户才能与页面交互。

于是，我们是思路是：当视频播放时，调用focus()方法，使得播放器获得焦点。

如何获取播放器的DOM元素？可以使用React的ref。
参考[Refs and the DOM](https://reactjs.org/docs/refs-and-the-dom.html)

如何在插件代码中获取React组件？可以从它的外部传`this`进去。

尝试改进代码：

VideoPlayer.js
```
··· ···
render () {
  // write a plugin
  var that = this
  const setStateandFocusPlugin = function (options) {
    this.on('play', function (e) {
      console.log('playback has started!')

      // 控制台输出结果表明成功获取VideoPlayer组件
      console.log(that)

      this.setState({
        state: 'playing'
      })
      // 控制焦点
      that.refs.videoPlayerRef.focus()
    })
    ... ...
    return (
      <div data-vjs-player
        onKeyDown={this.handleSpaceKeyDown}
        ref='videoPlayerRef'
        >
        <video
          ref={node => this.videoNode = node}
          className='video-js vjs-hqcat'
        />
      </div>
    )
  }
}
```

现在再试用播放器，可以发现第一个问题已经解决了。点开视频后，直接按空格键，视频暂停。

第二个问题依然存在。这是因为 `this.on('play', cb)` 这个监听事件不是持续的。视频播放的过程中，再点击页面的其他地方，播放器会市区焦点。

有没有更好的方法？video.js的github issue里，官方人员提及video.js支持全部原生 HTML5 media elements events, 仔细查阅[W3C Recommendation文档media event summary部分](https://www.w3.org/TR/html5/embedded-content-0.html#mediaevents)，以及官方人员的[events文档](http://docs.videojs.com/docs/api/player.html#events)，发现这一条：

>**timeupdate**
>
>Fired when the current playback position has changed * During playback this is fired every >15-250 milliseconds, depending on the playback technology in use.
>
>Defined in https://github.com/videojs/video.js/blob/master/src/js/player.js line number: 2792


只要在播放，就会持续监听到该事件。十分适合用来解决我们的问题。有了它，`this.on('play', cb)`的回调中也不需要进行焦点控制了。

根据该插件的功能，将其命名为`setStateandFocusPlugin`，完整代码如下

VideoPlayer.js
```
··· ···
const setStateandFocusPlugin = function (options) {
  this.on('play', function (e) {
    console.log('playback has started!')
    console.log(that)
    this.setState({
      state: 'playing'
    })
  })

  this.on('pause', function (e) {
    console.log('playback has paused')
    this.setState({
      state: 'pause'
    })
  })

  this.on('timeupdate', function(e){
    that.refs.videoPlayerRef.focus()
  })
}
... ...
```

注意，注册以及使用插件的代码中也需要同步改名。

现在再来尝试，发现第二个问题也解决了。

目前的代码可以实现：
* 当视频播放的过程中，不论鼠标点哪里，都让焦点保持在播放器，以便通过空格键控制；
* 看视频时也可能需要暂停下来做别的事情，那么当视频处于暂停状态，就可以通过鼠标点击等行为切换焦点。


空格键控制播放/暂停的功能就比较完善了。

#### 总结

这一小节，我们实现了一个video.js的插件（涉及到插件的注册，使用等），通过它监听播放器实例的事件，在不同的事件被触发时，进行相应的操作：
* 当监听到播放（`play`）事件的触发，设置播放器实例状态为`playing`
* 当监听到暂停（`pause`）事件的触发，设置播放器实例状态为`pause`
* 当监听到`timeupdate`事件的触发，让播放器组件获得焦点，涉及到
  * focus()方法
  * ref

然后，监听键盘事件，当监听到用户按下空格键时，禁止原来的默认动作，再根据播放器实例此时的状态，进行相应的操作
* 若正在播放中，则暂停之
* 若视频被暂停，则播放之

涉及到：
  * event.preventDefault()
  * onKeyDown
  * 事件冒泡
  * 键码
